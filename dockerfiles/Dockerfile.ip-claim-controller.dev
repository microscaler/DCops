# Development Dockerfile for IP Claim Controller (Tilt/local dev)
# Binary is cross-compiled on host (Apple Silicon -> x86_64 Linux) and copied in
# Standard development Dockerfile pattern
# Uses pre-built base image with minimal runtime dependencies

ARG TARGETPLATFORM=linux/amd64
FROM docker.io/microscaler/dcops-controller-base-image:latest

# Base image already has:
# - ca-certificates
# - /app directory with proper permissions
# - Environment variables (RUST_BACKTRACE, RUST_LOG)

# WORKDIR is already set to /app in base image

# Copy pre-built binary from target directory (x86_64 Linux musl target)
# Note: Binary must exist before Docker build (ensured by Tilt deps or local build)
# Copy from target directory directly (release build for production-like testing)
# Path is relative to context (project root), so target/ is at the root
COPY target/x86_64-unknown-linux-musl/release/ip-claim-controller /app/ip-claim-controller

# Make binary executable
# Verify file exists and set permissions (fail fast if file is missing)
RUN test -f /app/ip-claim-controller && \
    chmod +x /app/ip-claim-controller

# Set runtime environment
ENV RUST_BACKTRACE=1
ENV RUST_LOG=info

# Run the controller
ENTRYPOINT ["/app/ip-claim-controller"]

