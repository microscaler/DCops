# Production Dockerfile for PXE Intent Controller
# Multi-stage build that compiles the Rust binary inside Docker
# This is used for production builds with docker buildx

# Stage 1: Build the Rust binary
# Uses pre-built Rust builder base image with all build dependencies
ARG BUILDPLATFORM=linux/amd64
FROM --platform=$BUILDPLATFORM docker.io/microscaler/dcops-rust-builder-base-image:latest AS builder

# Build arguments for build.rs (if needed)
ARG BUILD_GIT_HASH=unknown
ARG BUILD_TIMESTAMP
ARG BUILD_DATETIME

# Base image already has:
# - Rust toolchain (1.92)
# - Build dependencies (pkg-config, libssl-dev, git, curl, musl-tools)
# - Git configuration (safe.directory, init.defaultBranch)
# - Working directory (/build)
# - Environment variables (CARGO_NET_GIT_FETCH_WITH_CLI, RUST_BACKTRACE)
# - Pre-cached dependencies

# Copy workspace Cargo files first for better layer caching
COPY Cargo.toml Cargo.lock* ./

# Copy crate Cargo files
COPY crates/crds/Cargo.toml ./crates/crds/
COPY crates/netbox-client/Cargo.toml ./crates/netbox-client/
COPY crates/pxe-server/Cargo.toml ./crates/pxe-server/

# Copy controller Cargo file
COPY controllers/pxe-intent/Cargo.toml ./controllers/pxe-intent/

# Copy source code
COPY crates/crds/src ./crates/crds/src
COPY crates/netbox-client/src ./crates/netbox-client/src
COPY crates/pxe-server/src ./crates/pxe-server/src
COPY controllers/pxe-intent/src ./controllers/pxe-intent/src

# Build the binary in release mode with optimizations
# Use --locked to ensure Cargo.lock is respected and transitive dependencies resolve correctly
# CARGO_NET_GIT_FETCH_WITH_CLI=true forces Cargo to use git CLI instead of libgit2
# RUSTFLAGS="-C link-arg=-s" strips debug symbols to reduce binary size
# Build for musl target for static linking (no glibc dependency)
RUN BUILD_GIT_HASH=${BUILD_GIT_HASH} \
    BUILD_TIMESTAMP=${BUILD_TIMESTAMP} \
    BUILD_DATETIME=${BUILD_DATETIME} \
    CARGO_NET_GIT_FETCH_WITH_CLI=true \
    RUSTFLAGS="-C link-arg=-s" \
    CC_x86_64_unknown_linux_musl=musl-gcc \
    CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_LINKER=musl-gcc \
    cargo build --release --locked --target x86_64-unknown-linux-musl --bin pxe-intent-controller && \
    # Strip the binary to remove debug symbols (further size reduction)
    strip target/x86_64-unknown-linux-musl/release/pxe-intent-controller

# Stage 2: Runtime image
# Uses pre-built base image with minimal runtime dependencies
FROM docker.io/microscaler/dcops-controller-base-image:latest

# Base image already has:
# - ca-certificates
# - /app directory with proper permissions
# - Environment variables (RUST_BACKTRACE, RUST_LOG)

# WORKDIR is already set to /app in base image

# Copy binary from builder stage
COPY --from=builder /build/target/x86_64-unknown-linux-musl/release/pxe-intent-controller /app/pxe-intent-controller
RUN chmod +x /app/pxe-intent-controller

# Set runtime environment
ENV RUST_BACKTRACE=1
ENV RUST_LOG=info

# Run the controller
ENTRYPOINT ["/app/pxe-intent-controller"]

