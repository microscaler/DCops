//! # CRD Generator
//!
//! Generates Kubernetes CustomResourceDefinition (CRD) YAML from Rust type definitions.
//!
//! This binary uses the `kube` crate's `CustomResourceExt` trait to generate
//! the CRD YAML for all DCops resources.
//!
//! ## Usage
//!
//! ```bash
//! # Generate all CRDs
//! cargo run -p crds --bin crdgen > config/crd/all-crds.yaml
//!
//! # Generate and apply directly
//! cargo run -p crds --bin crdgen | kubectl apply -f -
//! ```
//!
//! The generated CRDs include:
//! - OpenAPI schema validation
//! - Required fields
//! - Default values
//! - Status subresources

use crds::ip_claim::IPClaim;
use crds::ip_pool::IPPool;
use crds::boot_profile::BootProfile;
use crds::boot_intent::BootIntent;

// DCIM resources
use crds::dcim::{
    NetBoxRegion,
    NetBoxSiteGroup,
    NetBoxLocation,
    NetBoxSite,
    NetBoxDeviceRole,
    NetBoxManufacturer,
    NetBoxPlatform,
    NetBoxDeviceType,
    NetBoxDevice,
    NetBoxInterface,
    NetBoxMACAddress,
};

// IPAM resources
use crds::ipam::{
    NetBoxPrefix,
    NetBoxAggregate,
    NetBoxRole,
    NetBoxVLAN,
};

// Tenancy resources
use crds::tenancy::NetBoxTenant;

// Extras resources
use crds::extras::NetBoxTag;
use kube::core::CustomResourceExt;

fn main() {
    // Generate CRD YAML for all resources
    let mut crds = Vec::new();
    
    // IPAM resources
    crds.push(IPClaim::crd());
    crds.push(IPPool::crd());
    crds.push(NetBoxPrefix::crd());
    crds.push(NetBoxTenant::crd());
    
    // DCIM resources - Sites
    crds.push(NetBoxRegion::crd());
    crds.push(NetBoxSiteGroup::crd());
    crds.push(NetBoxLocation::crd());
    crds.push(NetBoxSite::crd());
    
    // IPAM resources
    crds.push(NetBoxRole::crd());
    crds.push(NetBoxTag::crd());
    crds.push(NetBoxAggregate::crd());
    crds.push(NetBoxVLAN::crd());
    
    // Boot resources
    crds.push(BootProfile::crd());
    crds.push(BootIntent::crd());
    
    // DCIM resources - Devices (for PXE/Pi clusters)
    crds.push(NetBoxDeviceRole::crd());
    crds.push(NetBoxManufacturer::crd());
    crds.push(NetBoxPlatform::crd());
    crds.push(NetBoxDeviceType::crd());
    crds.push(NetBoxDevice::crd());
    crds.push(NetBoxInterface::crd());
    crds.push(NetBoxMACAddress::crd());
    
    // Print header comments
    println!("# This file is auto-generated by crdgen");
    println!("# DO NOT EDIT THIS FILE MANUALLY");
    println!("# If there are malformed YAML issues, fix them in the Rust code (crates/crds/src/)");
    println!("# This file will be overwritten on every code update");
    println!("#");
    
    // Serialize each CRD to YAML
    for crd in crds {
        println!("---");
        match serde_yaml::to_string(&crd) {
            Ok(yaml) => {
                print!("{yaml}");
            }
            Err(e) => {
                eprintln!("Failed to serialize CRD to YAML: {e}");
                std::process::exit(1);
            }
        }
    }
}

